#!/bin/bash

SYS=$(uname -s)
HEAD="head"
case $SYS in
    Darwin)
        GHEAD=$(command -v ghead)
        if [ -z "$GHEAD" ]; then
            echo "Since you're on a Mac, you'll need to 'brew install coreutils' first"
            exit
        fi
        HEAD="$GHEAD"
        ;;
esac

JUPYTER=$(command -v jupyter)
if [ -z "$JUPYTER" ]; then
    echo "Jupyter not found in path. Please install jupyter."
    exit
fi

SITE_ROOT=$(git rev-parse --show-toplevel)
DOC_VERSION=$(grep doc_version: $SITE_ROOT/_config.yml |awk -F: '{print $2}' |xargs)

TRIBUO_DIR="${SITE_ROOT}/tribuo"
if [[ $# -eq 1 ]] ; then
    TRIBUO_DIR=$1
fi

TUTORIALS=$(ls "${TRIBUO_DIR}"/tutorials/*.ipynb)


UNORDERED=320
for tut in $TUTORIALS; do
    # You know what's not so great? Converting this to markdown first to get
    # the title easily.  But guess what?  Here we go!
    $JUPYTER nbconvert --to markdown $tut > /dev/null 2>&1
    MD="${tut%.*}.md"
    TITLE=$($HEAD -1 "$MD" |sed s/\#// |sed s/Tutorial// |xargs)

    # Is this a recognized title?
    case $TITLE in
        *Classification*)
            ORDER=301
            ;;
        *Clustering*)
            ORDER=302
            ;;
        *Regression*)
            ORDER=303
            ;;
        *Anomaly*)
            ORDER=304
            ;;
        *Configuration*)
            ORDER=305
            ;;
        *)
            ORDER=$UNORDERED
            UNORDERED=$(($UNORDERED + 1))
            ;;
    esac

    # Convert the notebook to html
    $JUPYTER nbconvert --to html $tut > /dev/null 2>&1
    HTML="${tut%.*}.html"
    TARGET=${SITE_ROOT}/learn/$DOC_VERSION/tutorials/$(basename $HTML)
    NOTEBOOK_URL="https://github.com/oracle/tribuo/blob/main/tutorials/$(basename $tut)"

    cat << EOF > $TARGET
---
title: "$TITLE"
og-title: "$TITLE Tutorial"
learn_nav: true
parent: Tutorials
nav_order: $ORDER
is_notebook: true
notebook_url: $NOTEBOOK_URL
comment: ## DO NOT EDIT THIS FILE. IT IS COPIED FROM THE TRIBUO DOC. EDIT IT THERE. ##
---
EOF
    tail -n +`awk '/    <div class="container" id="notebook-container">/ {print FNR}' $HTML ` $HTML |$HEAD -n -7 >> $TARGET
    echo "Created $TARGET"
    rm $HTML
    rm $MD
done
